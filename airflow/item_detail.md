# üìÇ Î™©Î°ù

- ü™§ [Airflow Íµ¨Ï∂ïÌïòÍ∏∞ (Nas, Ubuntu)](./airflow.md)
- ‚ö†Ô∏è [Îç∞Ïù¥ÌÑ∞ Î∂àÏùºÏπò](./different_data.md)
- üåê [Îã§Íµ≠Ïñ¥ Îç∞Ïù¥ÌÑ∞ Îß§Ìïë Î∞è Ï≤òÎ¶¨Îüâ Ï¶ùÍ∞Ä Î¨∏Ï†ú](./i18n_mapping.md)
- üîπ [Îã§Íµ≠Ïñ¥ ÏõêÏ≤ú Îç∞Ïù¥ÌÑ∞Ïùò Ïã†Î¢∞ÎèÑ Î¨∏Ï†ú](./untranslated_data.md)
- üì¶ [Data Dump ÏûêÎèôÌôî ÏÑ§Ï†ï](./data_dump.md)
- üêπ [ÏãúÏä§ÌÖú Health Check Íµ¨Ï∂ï](./health_check.md)
- üß† [ÏïÑÏù¥ÌÖú ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ ÏÑ±Îä• ÌäúÎãù ÌõÑÍ∏∞](./item_detail.md)

# üß† ÏïÑÏù¥ÌÖú ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ ÏÑ±Îä• ÌäúÎãù ÌõÑÍ∏∞

## üìå Í∞úÏöî

ÏïÑÏù¥ÌÖú ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ Ï°∞Ìöå Ïãú, ÏùëÎãµ ÏãúÍ∞ÑÏù¥ ÎÑàÎ¨¥ Ïò§Îûò Í±∏Î¶¨Îäî Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌïòÏòÄÏäµÎãàÎã§.  
Í∏∞Ï°¥ Ï°∞ÌöåÎäî 5Ï¥à Ïù¥ÎÇ¥Î°ú ÎÅùÎÇ¨ÏßÄÎßå, ÏÇ¨Ïö©Ïûê ÏûÖÏû•ÏóêÏÑú Ï≤¥Í∞êÏÉÅ Ï∂©Î∂ÑÌûà Î∂àÌé∏Ìï† Ïàò ÏûàÎã§Í≥† ÌåêÎã®ÌïòÏó¨ ÏÑ±Îä• Í∞úÏÑ† ÏûëÏóÖÏùÑ ÏßÑÌñâÌïòÍ≤å ÎêòÏóàÏäµÎãàÎã§.

**Í∏∞Ï°¥ ÏïÑÏù¥ÌÖú ÏÉÅÏÑ∏ Ï°∞Ìöå ÏÜçÎèÑ**

https://github.com/user-attachments/assets/30fd5cf6-28f2-4333-bba0-1d5f299c1013

---

## üìÑ ÏøºÎ¶¨ ÏÑ§Î™Ö Î∞è ÏÑ±Îä• Î∂ÑÏÑù

### ‚úÖ ÏøºÎ¶¨ Î™©Ï†Å

`item_i18n` ÌÖåÏù¥Î∏îÏùÑ Í∏∞Ï§ÄÏúºÎ°ú ÌïòÏó¨, Ìï¥Îãπ ÏïÑÏù¥ÌÖúÏù¥ Ïñ¥Îñ§ Ïö©ÎèÑÎ°ú ÏÇ¨Ïö©ÎêòÎäîÏßÄ ÎòêÎäî Ïñ¥Îñ§ Î≥¥ÏÉÅÏúºÎ°ú Ï†úÍ≥µÎêòÎäîÏßÄÎ•º ÌååÏïÖÌïòÏó¨  
**ÌïòÎÇòÏùò JSON ÌòïÌÉúÎ°ú ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Î∞òÌôò**ÌïòÎäî Î™©Ï†ÅÏùò ÏøºÎ¶¨ÏûÖÎãàÎã§.

**Í∏∞Ï°¥ ÏÇ¨Ïö© ÏøºÎ¶¨**

```sql
            WITH target_item AS (SELECT *
                                 FROM item_i18n
                                 WHERE url_mapping = :url_mapping
                                 limit 1),

                 -- üì¶ Î∞îÌÑ∞ Ï†ïÎ≥¥
                 filtered_barters AS (SELECT n.id                      AS npc_id,
                                             n.name,
                                             n.image,
                                             jsonb_build_object(
                                                     'level', barter ->> 'level',
                                                     'rewardItems', reward,
                                                     'requiredItems', barter -> 'requiredItems'
                                             )                         AS matching_barter,
                                             reward -> 'item' ->> 'id' AS reward_item_id
                                      FROM npc_i18n n,
                                           jsonb_array_elements(n.barter_info) AS barter,
                                           jsonb_array_elements(barter -> 'rewardItems') AS reward),

                 -- üõ† ÏùÄÏã†Ï≤ò Í±¥ÏÑ§Ïóê ÏÇ¨Ïö©ÎêòÎäî Ï†ïÎ≥¥
                 filtered_hideout AS (SELECT thir.id,
                                             thir.level_id,
                                             thir.name,
                                             thir.quantity,
                                             thir.count,
                                             thir.image,
                                             thir.item_id,
                                             thm.name as master_name,
                                             thm.id   as master_id
                                      FROM hideout_item_require_i18n thir
                                               LEFT JOIN hideout_master_i18n thm
                                                         ON SPLIT_PART(thir.level_id, '-', 1) = thm.id),

                 -- üõ† ÏùÄÏã†Ï≤ò Ï†úÏûëÏóê ÏÇ¨Ïö©ÎêòÎäî Ï†ïÎ≥¥
                 filtered_crafts AS (SELECT thc.*,
                                            thm.name                as master_name,
                                            thm.id                  as master_id,
                                            elem -> 'item' ->> 'id' AS required_item_id
                                     FROM hideout_crafts_i18n thc
                                              LEFT JOIN LATERAL jsonb_array_elements(thc.req_item) AS elem on True
                                              LEFT JOIN hideout_master_i18n thm ON SPLIT_PART(thc.level_id, '-', 1) = thm.id),

                 -- üéØ ÌÄòÏä§Ìä∏ Î≥¥ÏÉÅÏúºÎ°ú ÏÇ¨Ïö©ÎêòÎäî Ï†ïÎ≥¥
                 filtered_quests AS (SELECT qa.id                                           AS quest_id,
                                            qa.name,
                                            qa.npc_id,
                                            qa.url_mapping,
                                            tn.name                                         as npc_name,
                                            tn.image                                        AS npc_image,
                                            jsonb_array_elements(finish_rewards -> 'items') AS reward_elem
                                     FROM quest_i18n qa
                                              left join npc_i18n tn on qa.npc_id = tn.id),

                 -- üéØ offer unlockÏúºÎ°ú ÏÇ¨Ïö©ÎêòÎäî Ï†ïÎ≥¥
                 filtered_quests_offer_unlock AS (SELECT qa.id AS quest_id,
                                                         qa.name,
                                                         qa.npc_id,
                                                         qa.url_mapping,
                                                         tn.name as npc_name,
                                                         tn.image AS npc_image,
                                                         jsonb_array_elements(finish_rewards -> 'offerUnlock') AS reward_elem
                                                  FROM quest_i18n qa
                                                           left join npc_i18n tn on qa.npc_id = tn.id),

                 -- üß© craftUnlock.rewardItems[*].item.idÏóê Ìè¨Ìï®Îêú Í≤ΩÏö∞ (finish_rewards Ïïà)
                 filtered_quests_craft_unlock AS (
                     SELECT qa.id AS quest_id,
                            qa.name,
                            qa.npc_id,
                            qa.url_mapping,
                            tn.name as npc_name,
                            tn.image AS npc_image,
                            reward_item
                     FROM quest_i18n qa
                              LEFT JOIN npc_i18n tn ON qa.npc_id = tn.id
                              LEFT JOIN LATERAL jsonb_array_elements(qa.finish_rewards -> 'craftUnlock') AS craft_unlock ON TRUE
                              LEFT JOIN LATERAL jsonb_array_elements(craft_unlock -> 'rewardItems') AS reward_item ON TRUE
                     WHERE reward_item -> 'item' ->> 'id' = (SELECT id FROM target_item)
                 ),

                 -- ‚ùó questItemÏóê Ìè¨Ìï®Îêú Í≤ΩÏö∞ (Ïòà: giveQuestItem, findQuestItem)
                 required_quests_by_quest_item AS (SELECT q.id     AS quest_id,
                                                          q.name,
                                                          q.url_mapping,
                                                          tn.name  AS npc_name,
                                                          tn.image AS npc_image,
                                                          obj      AS objective
                                                   FROM quest_i18n q
                                                            LEFT JOIN LATERAL jsonb_array_elements(q.objectives) AS obj ON TRUE
                                                            LEFT JOIN npc_i18n tn ON q.npc_id = tn.id
                                                   WHERE obj ->> 'type' IN ('findQuestItem', 'giveQuestItem')),

                 -- ‚ùó items Î∞∞Ïó¥Ïóê Ìè¨Ìï®Îêú Í≤ΩÏö∞ (Ïòà: giveItem, plantItem, findItem)
                 required_quests_by_items_array AS (SELECT q.id     AS quest_id,
                                                           q.name,
                                                           q.url_mapping,
                                                           tn.name  as npc_name,
                                                           tn.image AS npc_image,
                                                           obj      AS objective
                                                    FROM quest_i18n q
                                                             LEFT JOIN LATERAL jsonb_array_elements(q.objectives) AS obj ON TRUE
                                                             LEFT JOIN npc_i18n tn on q.npc_id = tn.id
                                                    WHERE obj ->> 'type' IN ('plantItem', 'giveItem', 'findItem')
                                                      AND EXISTS (SELECT 1
                                                                  FROM jsonb_array_elements(obj -> 'items') AS item
                                                                  WHERE item ->> 'id' = (SELECT id FROM target_item))),

                 item_with_details AS (SELECT ti.id,
                                              ti.name,
                                              ti.category,
                                              ti.image,
                                              ti.image_width,
                                              ti.image_height,
                                              ti.info,
                                              ti.update_time,
                                              ti.url_mapping,

                                              -- ÏùÄÏã†Ï≤ò ÏïÑÏù¥ÌÖú ÏöîÍµ¨ Ï†ïÎ≥¥
                                              COALESCE(
                                                              json_agg(
                                                              DISTINCT jsonb_build_object(
                                                                      'id', thir.id,
                                                                      'level_id', thir.level_id,
                                                                      'name', thir.name,
                                                                      'quantity', thir.quantity,
                                                                      'count', thir.count,
                                                                      'image', thir.image,
                                                                      'item_id', thir.item_id,
                                                                      'master_name', thir.master_name,
                                                                      'master_id', thir.master_id
                                                                       )
                                                                      ) FILTER (WHERE thir.id IS NOT NULL),
                                                              '[]'
                                              ) AS hideout_items,

                                              -- ÏùÄÏã†Ï≤ò Ï†úÏûëÏóê ÏÇ¨Ïö©
                                              COALESCE(
                                                              json_agg(
                                                              DISTINCT jsonb_build_object(
                                                                      'id', thc.id,
                                                                      'name', thc.name,
                                                                      'level_id', thc.level_id,
                                                                      'level', thc.level,
                                                                      'duration', thc.duration,
                                                                      'req_item', thc.req_item,
                                                                      'reward_item_id', thc.reward_item_id,
                                                                      'image', thc.image,
                                                                      'quantity', thc.quantity,
                                                                      'master_name', thc.master_name,
                                                                      'master_id', thc.master_id
                                                                       )
                                                                      ) FILTER (WHERE thc.id IS NOT NULL),
                                                              '[]'
                                              ) AS used_in_crafts,

                                              -- NPC Î∞îÌÑ∞ Î≥¥ÏÉÅÏúºÎ°ú ÎÇòÏò§Îäî Ï†ïÎ≥¥
                                              COALESCE(
                                                              json_agg(
                                                              DISTINCT jsonb_build_object(
                                                                      'npc_id', fb.npc_id,
                                                                      'npc_image', fb.image,
                                                                      'npc_name', fb.name,
                                                                      'barter_info', fb.matching_barter
                                                                       )
                                                                      ) FILTER (WHERE fb.npc_id IS NOT NULL),
                                                              '[]'
                                              ) AS rewarded_by_npcs,

                                              -- ÌÄòÏä§Ìä∏ Î≥¥ÏÉÅÏúºÎ°ú ÎÇòÏò§Îäî Ï†ïÎ≥¥
                                              COALESCE(
                                                              json_agg(
                                                              DISTINCT jsonb_build_object(
                                                                      'quest_id', fq.quest_id,
                                                                      'name', fq.name,
                                                                      'npc_name', fq.npc_name,
                                                                      'npc_image', fq.npc_image,
                                                                      'url_mapping', fq.url_mapping,
                                                                      'reward', fq.reward_elem
                                                                       )
                                                                      ) FILTER (WHERE fq.quest_id IS NOT NULL),
                                                              '[]'
                                              ) AS rewarded_by_quests,

                                              -- ÌÄòÏä§Ìä∏ Î≥¥ÏÉÅÏúºÎ°ú ÎÇòÏò§Îäî Ï†ïÎ≥¥
                                              COALESCE(
                                                              json_agg(
                                                              DISTINCT jsonb_build_object(
                                                                      'quest_id', fqon.quest_id,
                                                                      'name', fqon.name,
                                                                      'npc_name', fqon.npc_name,
                                                                      'npc_image', fqon.npc_image,
                                                                      'url_mapping', fqon.url_mapping,
                                                                      'reward', fqon.reward_elem
                                                                       )
                                                                      ) FILTER (WHERE fqon.quest_id IS NOT NULL),
                                                              '[]'
                                              ) AS rewarded_by_quests_offer_unlock,

                                              -- ÌÄòÏä§Ìä∏ craftUnlockÏùò rewardItemsÏóê Ìè¨Ìï®Îêú Ï†ïÎ≥¥
                                              COALESCE(
                                                              json_agg(
                                                              DISTINCT jsonb_build_object(
                                                                      'quest_id', fqc.quest_id,
                                                                      'name', fqc.name,
                                                                      'npc_name', fqc.npc_name,
                                                                      'npc_image', fqc.npc_image,
                                                                      'url_mapping', fqc.url_mapping,
                                                                      'reward', fqc.reward_item
                                                                       )
                                                                      ) FILTER (WHERE fqc.quest_id IS NOT NULL),
                                                              '[]'
                                              ) AS rewarded_by_quests_craft_unlock,

                                              -- üìå questItemÏóê Îì§Ïñ¥ ÏûàÎäî ÌÄòÏä§Ìä∏
                                              COALESCE(
                                                              json_agg(
                                                              DISTINCT jsonb_build_object(
                                                                      'quest_id', rqi.quest_id,
                                                                      'name', rqi.name,
                                                                      'npc_name', rqi.npc_name,
                                                                      'npc_image', rqi.npc_image,
                                                                      'url_mapping', rqi.url_mapping,
                                                                      'objective', rqi.objective
                                                                       )
                                                                      ) FILTER (
                                                                  WHERE rqi.objective -> 'questItem' ->> 'id' = ti.id
                                                                  ),
                                                              '[]'
                                              ) AS required_by_quest_item,

                                              -- üìå items Î∞∞Ïó¥Ïóê Îì§Ïñ¥ ÏûàÎäî ÌÄòÏä§Ìä∏
                                              COALESCE(
                                                              json_agg(
                                                              DISTINCT jsonb_build_object(
                                                                      'quest_id', rqa.quest_id,
                                                                      'name', rqa.name,
                                                                      'npc_name', rqa.npc_name,
                                                                      'npc_image', rqa.npc_image,
                                                                      'url_mapping', rqa.url_mapping,
                                                                      'objective', rqa.objective
                                                                       )
                                                                      ) FILTER (WHERE rqa.quest_id IS NOT NULL),
                                                              '[]'
                                              ) AS required_by_quest_item_array

                                       FROM target_item ti
                                                LEFT JOIN filtered_hideout thir ON ti.id = thir.item_id
                                                LEFT JOIN filtered_crafts thc ON thc.required_item_id = ti.id
                                                LEFT JOIN filtered_barters fb ON fb.reward_item_id = ti.id
                                                LEFT JOIN filtered_quests fq ON fq.reward_elem -> 'item' ->> 'id' = ti.id
                                                LEFT JOIN required_quests_by_quest_item rqi ON rqi.objective -> 'questItem' ->> 'id' = ti.id
                                                LEFT JOIN filtered_quests_offer_unlock fqon ON fqon.reward_elem -> 'item' ->> 'id' = ti.id
                                                LEFT JOIN filtered_quests_craft_unlock fqc ON TRUE
                                                LEFT JOIN required_quests_by_items_array rqa ON TRUE
                                       GROUP BY ti.id, ti.name, ti.name, ti.category, ti.image,
                                                ti.image_width, ti.image_height, ti.info, ti.update_time, ti.url_mapping)

            SELECT *
            FROM item_with_details
```

### üß© Ï£ºÏöî ÏÑúÎ∏åÏøºÎ¶¨ ÏÑ§Î™Ö

| CTE Ïù¥Î¶Ñ                         | ÏÑ§Î™Ö                                                                               |
| -------------------------------- | ---------------------------------------------------------------------------------- |
| `target_item`                    | `item_i18n` Ï†ÑÏ≤¥                                                                   |
| `filtered_barters`               | NPC Î∞îÌÑ∞ Î≥¥ÏÉÅ Ï§ë Ìï¥Îãπ ÏïÑÏù¥ÌÖúÏùÑ Ìè¨Ìï®ÌïòÎäî JSON Íµ¨Ï°∞ Ìï¥ÏÑù                             |
| `filtered_hideout`               | ÏùÄÏã†Ï≤ò Í±¥ÏÑ§Ïóê ÌïÑÏöîÌïú ÏïÑÏù¥ÌÖú Ï†ïÎ≥¥                                                   |
| `filtered_crafts`                | ÏùÄÏã†Ï≤ò Ï†úÏûë(crafts)Ïóê ÌïÑÏöîÌïú ÏïÑÏù¥ÌÖú Ï†ïÎ≥¥                                           |
| `filtered_quests`                | ÌÄòÏä§Ìä∏ Î≥¥ÏÉÅÏúºÎ°ú ÎÇòÏò§Îäî ÏïÑÏù¥ÌÖú                                                      |
| `filtered_quests_offer_unlock`   | ÌÄòÏä§Ìä∏Ïùò `offerUnlock` Î≥¥ÏÉÅÏóê Ìè¨Ìï®Îêú ÏïÑÏù¥ÌÖú                                        |
| `filtered_quests_craft_unlock`   | ÌÄòÏä§Ìä∏Ïùò `craftUnlock.rewardItems`Ïóê Ìè¨Ìï®Îêú ÏïÑÏù¥ÌÖú                                 |
| `required_quests_by_quest_item`  | ÌÄòÏä§Ìä∏Ïùò `questItem` Ìï≠Î™©Ïóê Ìè¨Ìï®Îêú ÏïÑÏù¥ÌÖú                                          |
| `required_quests_by_items_array` | ÌÄòÏä§Ìä∏Ïùò `items` Î∞∞Ïó¥(`giveItem`, `plantItem`, `findItem`)Ïóê Ìè¨Ìï®Îêú ÏïÑÏù¥ÌÖú         |
| `item_with_details`              | ÏúÑ ÏÑúÎ∏åÏøºÎ¶¨ Í≤∞Í≥ºÎ•º Î™®Îëê LEFT JOIN Î∞è `json_agg`Î°ú ÌÜµÌï©ÌïòÏó¨ ÏïÑÏù¥ÌÖúÎ≥Ñ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏÉùÏÑ± |

---

## üö® ÏÑ±Îä• Ïù¥Ïäà ÏõêÏù∏ Î∂ÑÏÑù

1. **`jsonb_array_elements` ÏÇ¨Ïö©**

   - JSON Î∞∞Ïó¥ÏùÑ Ìñâ Îã®ÏúÑÎ°ú ÌíÄÏñ¥ÎÇ¥Í∏∞ ÎïåÎ¨∏Ïóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÎßéÏùÑÏàòÎ°ù **ÎπÑÏö©Ïù¥ Í∏∞ÌïòÍ∏âÏàòÏ†ÅÏúºÎ°ú Ï¶ùÍ∞Ä**Ìï©ÎãàÎã§.

2. **`LEFT JOIN LATERAL` Î∞òÎ≥µ ÏÇ¨Ïö©**

   - Ï°∞Ïù∏ ÏàúÏÑú ÏµúÏ†ÅÌôîÍ∞Ä Ïñ¥Î†µÍ≥†, ÎÇ¥Î∂ÄÏóêÏÑú Îã§Ïãú JSON ÌååÏã±Ïù¥ ÏàòÌñâÎêòÎØÄÎ°ú **Ïù∏Îç±Ïä§ ÌôúÏö©Ïù¥ Ïñ¥Î†§ÏõÄ**.

3. **Ï°∞Í±¥ ÏóÜÎäî JOIN**

   - `LEFT JOIN ... ON TRUE` Î∞©ÏãùÏùÄ **Î™®Îì† RowÎ•º Ï°∞Ïù∏**ÌïòÏó¨ Îß§Ïö∞ ÎπÑÌö®Ïú®Ï†ÅÏûÖÎãàÎã§.

4. **Ï§ëÏ≤© JSON ÌïÑÎìú Ï†ëÍ∑º**
   - Ïòà: `reward_elem -> 'item' ->> 'id'` Í∞ôÏùÄ Î∞©ÏãùÏùÄ **Ïù∏Îç±Ïä§Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏùå**.

**explain Í≤∞Í≥º**

```txt
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|QUERY PLAN                                                                                                                                                                                                                                                                                                                                                            |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|Subquery Scan on item_with_details  (cost=313261324586346151936.00..314316243974285426688.00 rows=1 width=288)                                                                                                                                                                                                                                                        |
|  CTE target_item                                                                                                                                                                                                                                                                                                                                                     |
|    ->  Limit  (cost=0.00..484.48 rows=1 width=422)                                                                                                                                                                                                                                                                                                                   |
|          ->  Seq Scan on item_i18n  (cost=0.00..484.48 rows=1 width=422)                                                                                                                                                                                                                                                                                             |
|                Filter: (url_mapping = 'bolts'::text)                                                                                                                                                                                                                                                                                                                 |
|  ->  GroupAggregate  (cost=313261324586346151936.00..314316243974285426688.00 rows=1 width=520)                                                                                                                                                                                                                                                                      |
|        Group Key: ti.id, ti.name, ti.category, ti.image, ti.image_width, ti.image_height, ti.info, ti.update_time, ti.url_mapping                                                                                                                                                                                                                                    |
|        InitPlan 2                                                                                                                                                                                                                                                                                                                                                    |
|          ->  CTE Scan on target_item  (cost=0.00..0.02 rows=1 width=32)                                                                                                                                                                                                                                                                                              |
|        ->  Sort  (cost=313261324586346151936.00..313297701116964765696.00 rows=14550612247438080000 width=3520)                                                                                                                                                                                                                                                      |
|              Sort Key: ti.id, ti.name, ti.category, ti.image, ti.image_width, ti.image_height, ti.info, ti.update_time, ti.url_mapping, (jsonb_build_object('id', thir.id, 'level_id', thir.level_id, 'name', thir.name, 'quantity', thir.quantity, 'count', thir.count, 'image', thir.image, 'item_id', thir.item_id, 'master_name', thm.name, 'master_id', thm.id))|
|              ->  Nested Loop Left Join  (cost=30891.77..182628648502135744.00 rows=14550612247438080000 width=3520)                                                                                                                                                                                                                                                  |
|                    ->  Nested Loop Left Join  (cost=30891.77..745995409084647.00 rows=15031624222560000 width=3246)                                                                                                                                                                                                                                                  |
|                          ->  Hash Left Join  (cost=30890.50..4471425008.97 rows=310570748400 width=2972)                                                                                                                                                                                                                                                             |
|                                Hash Cond: (ti.id = ((reward.value -> 'item'::text) ->> 'id'::text))                                                                                                                                                                                                                                                                  |
|                                ->  Merge Left Join  (cost=24061.48..5703272.83 rows=282337044 width=2800)                                                                                                                                                                                                                                                            |
|                                      Merge Cond: (ti.id = (((fqon.reward_elem -> 'item'::text) ->> 'id'::text)))                                                                                                                                                                                                                                                     |
|                                      ->  Merge Left Join  (cost=12913.11..36512.47 rows=1166682 width=2526)                                                                                                                                                                                                                                                          |
|                                            Merge Cond: (ti.id = (((fq.reward_elem -> 'item'::text) ->> 'id'::text)))                                                                                                                                                                                                                                                 |
|                                            ->  Merge Left Join  (cost=1764.74..1873.31 rows=4821 width=2252)                                                                                                                                                                                                                                                         |
|                                                  Merge Cond: (ti.id = (((obj.value -> 'questItem'::text) ->> 'id'::text)))                                                                                                                                                                                                                                           |
|                                                  ->  Merge Left Join  (cost=619.21..627.62 rows=498 width=1978)                                                                                                                                                                                                                                                      |
|                                                        Merge Cond: (ti.id = thir.item_id)                                                                                                                                                                                                                                                                            |
|                                                        ->  Sort  (cost=574.51..574.98 rows=188 width=1627)                                                                                                                                                                                                                                                           |
|                                                              Sort Key: ti.id                                                                                                                                                                                                                                                                                         |
|                                                              ->  Hash Right Join  (cost=3.62..567.41 rows=188 width=1627)                                                                                                                                                                                                                                            |
|                                                                    Hash Cond: (((elem.value -> 'item'::text) ->> 'id'::text) = ti.id)                                                                                                                                                                                                                                |
|                                                                    ->  Nested Loop  (cost=3.59..448.00 rows=18800 width=1395)                                                                                                                                                                                                                                        |
|                                                                          ->  Hash Left Join  (cost=3.58..71.99 rows=188 width=1363)                                                                                                                                                                                                                                  |
|                                                                                Hash Cond: (split_part(thc.level_id, '-'::text, 1) = thm_1.id)                                                                                                                                                                                                                        |
|                                                                                ->  Seq Scan on hideout_crafts_i18n thc  (cost=0.00..67.88 rows=188 width=1263)                                                                                                                                                                                                       |
|                                                                                ->  Hash  (cost=3.26..3.26 rows=26 width=100)                                                                                                                                                                                                                                         |
|                                                                                      ->  Seq Scan on hideout_master_i18n thm_1  (cost=0.00..3.26 rows=26 width=100)                                                                                                                                                                                                  |
|                                                                          ->  Function Scan on jsonb_array_elements elem  (cost=0.00..1.00 rows=100 width=32)                                                                                                                                                                                                         |
|                                                                    ->  Hash  (cost=0.02..0.02 rows=1 width=264)                                                                                                                                                                                                                                                      |
|                                                                          ->  CTE Scan on target_item ti  (cost=0.00..0.02 rows=1 width=264)                                                                                                                                                                                                                          |
|                                                        ->  Sort  (cost=44.70..45.48 rows=315 width=351)                                                                                                                                                                                                                                                              |
|                                                              Sort Key: thir.item_id                                                                                                                                                                                                                                                                                  |
|                                                              ->  Hash Left Join  (cost=3.58..31.63 rows=315 width=351)                                                                                                                                                                                                                                               |
|                                                                    Hash Cond: (split_part(thir.level_id, '-'::text, 1) = thm.id)                                                                                                                                                                                                                                     |
|                                                                    ->  Seq Scan on hideout_item_require_i18n thir  (cost=0.00..27.15 rows=315 width=251)                                                                                                                                                                                                             |
|                                                                    ->  Hash  (cost=3.26..3.26 rows=26 width=100)                                                                                                                                                                                                                                                     |
|                                                                          ->  Seq Scan on hideout_master_i18n thm  (cost=0.00..3.26 rows=26 width=100)                                                                                                                                                                                                                |
|                                                  ->  Sort  (cost=1145.54..1147.96 rows=968 width=274)                                                                                                                                                                                                                                                                |
|                                                        Sort Key: (((obj.value -> 'questItem'::text) ->> 'id'::text))                                                                                                                                                                                                                                                 |
|                                                        ->  Nested Loop  (cost=1.25..1097.53 rows=968 width=274)                                                                                                                                                                                                                                                      |
|                                                              ->  Hash Left Join  (cost=1.25..361.85 rows=484 width=582)                                                                                                                                                                                                                                              |
|                                                                    Hash Cond: (q.npc_id = tn.id)                                                                                                                                                                                                                                                                     |
|                                                                    ->  Seq Scan on quest_i18n q  (cost=0.00..358.84 rows=484 width=492)                                                                                                                                                                                                                              |
|                                                                    ->  Hash  (cost=1.11..1.11 rows=11 width=140)                                                                                                                                                                                                                                                     |
|                                                                          ->  Seq Scan on npc_i18n tn  (cost=0.00..1.11 rows=11 width=140)                                                                                                                                                                                                                            |
|                                                              ->  Function Scan on jsonb_array_elements obj  (cost=0.00..1.50 rows=2 width=32)                                                                                                                                                                                                                        |
|                                                                    Filter: ((value ->> 'type'::text) = ANY ('{findQuestItem,giveQuestItem}'::text[]))                                                                                                                                                                                                                |
|                                            ->  Materialize  (cost=11148.37..11390.37 rows=48400 width=274)                                                                                                                                                                                                                                                           |
|                                                  ->  Sort  (cost=11148.37..11269.37 rows=48400 width=274)                                                                                                                                                                                                                                                            |
|                                                        Sort Key: (((fq.reward_elem -> 'item'::text) ->> 'id'::text))                                                                                                                                                                                                                                                 |
|                                                        ->  Subquery Scan on fq  (cost=1.25..1092.69 rows=48400 width=274)                                                                                                                                                                                                                                            |
|                                                              ->  ProjectSet  (cost=1.25..608.69 rows=48400 width=306)                                                                                                                                                                                                                                                |
|                                                                    ->  Hash Left Join  (cost=1.25..361.85 rows=484 width=643)                                                                                                                                                                                                                                        |
|                                                                          Hash Cond: (qa_1.npc_id = tn_3.id)                                                                                                                                                                                                                                                          |
|                                                                          ->  Seq Scan on quest_i18n qa_1  (cost=0.00..358.84 rows=484 width=553)                                                                                                                                                                                                                     |
|                                                                          ->  Hash  (cost=1.11..1.11 rows=11 width=140)                                                                                                                                                                                                                                               |
|                                                                                ->  Seq Scan on npc_i18n tn_3  (cost=0.00..1.11 rows=11 width=140)                                                                                                                                                                                                                    |
|                                      ->  Materialize  (cost=11148.37..11390.37 rows=48400 width=274)                                                                                                                                                                                                                                                                 |
|                                            ->  Sort  (cost=11148.37..11269.37 rows=48400 width=274)                                                                                                                                                                                                                                                                  |
|                                                  Sort Key: (((fqon.reward_elem -> 'item'::text) ->> 'id'::text))                                                                                                                                                                                                                                                     |
|                                                  ->  Subquery Scan on fqon  (cost=1.25..1092.69 rows=48400 width=274)                                                                                                                                                                                                                                                |
|                                                        ->  ProjectSet  (cost=1.25..608.69 rows=48400 width=306)                                                                                                                                                                                                                                                      |
|                                                              ->  Hash Left Join  (cost=1.25..361.85 rows=484 width=643)                                                                                                                                                                                                                                              |
|                                                                    Hash Cond: (qa_2.npc_id = tn_4.id)                                                                                                                                                                                                                                                                |
|                                                                    ->  Seq Scan on quest_i18n qa_2  (cost=0.00..358.84 rows=484 width=553)                                                                                                                                                                                                                           |
|                                                                    ->  Hash  (cost=1.11..1.11 rows=11 width=140)                                                                                                                                                                                                                                                     |
|                                                                          ->  Seq Scan on npc_i18n tn_4  (cost=0.00..1.11 rows=11 width=140)                                                                                                                                                                                                                          |
|                                ->  Hash  (cost=2338.02..2338.02 rows=110000 width=204)                                                                                                                                                                                                                                                                               |
|                                      ->  Nested Loop  (cost=0.02..2338.02 rows=110000 width=204)                                                                                                                                                                                                                                                                     |
|                                            ->  Nested Loop  (cost=0.00..23.11 rows=1100 width=172)                                                                                                                                                                                                                                                                   |
|                                                  ->  Seq Scan on npc_i18n n  (cost=0.00..1.11 rows=11 width=154)                                                                                                                                                                                                                                                     |
|                                                  ->  Function Scan on jsonb_array_elements barter  (cost=0.00..1.00 rows=100 width=32)                                                                                                                                                                                                                               |
|                                            ->  Memoize  (cost=0.01..1.01 rows=100 width=32)                                                                                                                                                                                                                                                                          |
|                                                  Cache Key: barter.value                                                                                                                                                                                                                                                                                             |
|                                                  Cache Mode: binary                                                                                                                                                                                                                                                                                                  |
|                                                  ->  Function Scan on jsonb_array_elements reward  (cost=0.01..1.00 rows=100 width=32)                                                                                                                                                                                                                               |
|                          ->  Materialize  (cost=1.27..4756.10 rows=48400 width=274)                                                                                                                                                                                                                                                                                  |
|                                ->  Nested Loop  (cost=1.27..2717.10 rows=48400 width=274)                                                                                                                                                                                                                                                                            |
|                                      ->  Nested Loop Left Join  (cost=1.25..1329.85 rows=48400 width=274)                                                                                                                                                                                                                                                            |
|                                            ->  Hash Left Join  (cost=1.25..361.85 rows=484 width=643)                                                                                                                                                                                                                                                                |
|                                                  Hash Cond: (qa.npc_id = tn_1.id)                                                                                                                                                                                                                                                                                    |
|                                                  ->  Seq Scan on quest_i18n qa  (cost=0.00..358.84 rows=484 width=553)                                                                                                                                                                                                                                               |
|                                                  ->  Hash  (cost=1.11..1.11 rows=11 width=140)                                                                                                                                                                                                                                                                       |
|                                                        ->  Seq Scan on npc_i18n tn_1  (cost=0.00..1.11 rows=11 width=140)                                                                                                                                                                                                                                            |
|                                            ->  Function Scan on jsonb_array_elements craft_unlock  (cost=0.01..1.00 rows=100 width=32)                                                                                                                                                                                                                               |
|                                      ->  Memoize  (cost=0.01..1.77 rows=1 width=32)                                                                                                                                                                                                                                                                                  |
|                                            Cache Key: craft_unlock.value                                                                                                                                                                                                                                                                                             |
|                                            Cache Mode: binary                                                                                                                                                                                                                                                                                                        |
|                                            ->  Function Scan on jsonb_array_elements reward_item  (cost=0.01..1.76 rows=1 width=32)                                                                                                                                                                                                                                  |
|                                                  Filter: (((value -> 'item'::text) ->> 'id'::text) = (InitPlan 2).col1)                                                                                                                                                                                                                                              |
|                    ->  Materialize  (cost=0.00..75118.62 rows=968 width=274)                                                                                                                                                                                                                                                                                         |
|                          ->  Nested Loop Left Join  (cost=0.00..75113.78 rows=968 width=274)                                                                                                                                                                                                                                                                         |
|                                Join Filter: (q_1.npc_id = tn_2.id)                                                                                                                                                                                                                                                                                                   |
|                                ->  Nested Loop  (cost=0.00..74965.02 rows=968 width=184)                                                                                                                                                                                                                                                                             |
|                                      ->  Seq Scan on quest_i18n q_1  (cost=0.00..358.84 rows=484 width=492)                                                                                                                                                                                                                                                          |
|                                      ->  Function Scan on jsonb_array_elements obj_1  (cost=0.00..154.13 rows=2 width=32)                                                                                                                                                                                                                                            |
|                                            Filter: (((value ->> 'type'::text) = ANY ('{plantItem,giveItem,findItem}'::text[])) AND EXISTS(SubPlan 4))                                                                                                                                                                                                                |
|                                            SubPlan 4                                                                                                                                                                                                                                                                                                                 |
|                                              ->  Function Scan on jsonb_array_elements item  (cost=0.03..1.52 rows=1 width=0)                                                                                                                                                                                                                                        |
|                                                    Filter: ((value ->> 'id'::text) = (InitPlan 3).col1)                                                                                                                                                                                                                                                              |
|                                                    InitPlan 3                                                                                                                                                                                                                                                                                                        |
|                                                      ->  CTE Scan on target_item target_item_1  (cost=0.00..0.02 rows=1 width=32)                                                                                                                                                                                                                                    |
|                                ->  Materialize  (cost=0.00..1.17 rows=11 width=140)                                                                                                                                                                                                                                                                                  |
|                                      ->  Seq Scan on npc_i18n tn_2  (cost=0.00..1.11 rows=11 width=140)                                                                                                                                                                                                                                                              |
|JIT:                                                                                                                                                                                                                                                                                                                                                                  |
|  Functions: 182                                                                                                                                                                                                                                                                                                                                                      |
|  Options: Inlining true, Optimization true, Expressions true, Deforming true                                                                                                                                                                                                                                                                                         |
+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

```

---

## ‚öô Ïã§Ìñâ Î∞è ÌÖåÏä§Ìä∏

ÏÑ±Îä• Í∞úÏÑ†ÏùÑ ÏúÑÌï¥ ÏøºÎ¶¨Î•º ÏàòÏ†ïÌïú Îí§, ÌÖåÏä§Ìä∏Î•º ÏßÑÌñâÌïòÏòÄÏäµÎãàÎã§.

### Ï¥àÍ∏∞ ÌÖåÏä§Ìä∏ Í≤∞Í≥º

- `item_detail_i18n` Îç∞Ïù¥ÌÑ∞Îäî ÏïΩ 4200Ïó¨Í∞ú
- `LIMIT`ÏùÑ ÏÑ§Ï†ïÌïòÏßÄ ÏïäÏùÄ ÏÉÅÌÉúÏóêÏÑú Ïã§ÌñâÌñàÏúºÎÇò, **Ïª§ÎÑ•ÏÖòÏù¥ ÎÅäÍ∏∞Îäî Î¨∏Ï†ú**Í∞Ä Î∞úÏÉùÌïòÏòÄÏäµÎãàÎã§.
- `LIMIT 1000`Îßå Ï†ÅÏö©ÌñàÏùÑ ÎïåÎèÑ **10Î∂Ñ Ïù¥ÏÉÅ ÏÜåÏöî**ÎêòÏóàÏäµÎãàÎã§.
- `EXPLAIN` Í≤∞Í≥º, Í≥ºÎèÑÌïú Î¶¨ÏÜåÏä§ ÏÜåÎ™®Í∞Ä ÌôïÏù∏ÎêòÏóàÏäµÎãàÎã§.

---

## üåÄ Airflow Ï†ÅÏö© Î∞è Î∞∞Ïπò Ï≤òÎ¶¨

Îß§Ïùº ÏïÑÏù¥ÌÖú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÎØÄÎ°ú, Airflow DAGÎ•º ÌÜµÌï¥ **ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º ÌÜµÍ≥Ñ ÎÇ∏ ÌõÑ UPSERT Ï≤òÎ¶¨**ÌïòÎäî Î∞©ÏãùÏúºÎ°ú Î¶¨Ìå©ÌÑ∞ÎßÅÌïòÏòÄÏäµÎãàÎã§.

- Ï≤òÏùåÏóêÎäî `LIMIT / OFFSET`ÏùÑ ÏÇ¨Ïö©Ìï¥ **ÏàúÏ∞® Ïã§Ìñâ Î∞©Ïãù**ÏúºÎ°ú DAGÎ•º Íµ¨ÏÑ±ÌïòÏòÄÍ≥†,
- ÏïΩ **4200Í∞ú Îç∞Ïù¥ÌÑ∞Î•º Ï≤òÎ¶¨ÌïòÎäî Îç∞ 1ÏãúÍ∞Ñ Ïù¥ÏÉÅ ÏÜåÏöî**ÎêòÏóàÏäµÎãàÎã§.

**Airflow Ïã§Ìñâ Í≤∞Í≥º**

![long_time](https://github.com/user-attachments/assets/b03c6255-98a6-4e2b-88fe-ffb6ee1e50c3)

---

## üßØ Î¨∏Ï†ú Ïù∏ÏßÄ Î∞è ÏõêÏù∏

- ÌäπÏ†ï Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûòÎ™ª Îì§Ïñ¥Í∞Ä ÏûàÏóàÍ≥†, ÏøºÎ¶¨ ÏûêÏ≤¥Ïóê Î¨∏Ï†úÍ∞Ä ÏûàÏóàÏùåÏùÑ Îí§Îä¶Í≤å Ïù∏ÏßÄÌïòÍ≤å ÎêòÏóàÏäµÎãàÎã§.
- ÏÑ±Îä• Î≥ëÎ™©ÏùÄ ÏïÑÎûòÏôÄ Í∞ôÏùÄ **Î¨∏Ï†ú ÏøºÎ¶¨**ÏóêÏÑú Î∞úÏÉùÌïòÏòÄÏäµÎãàÎã§
- Îã®Ïùº Í∞íÏùÑ Ï°∞ÌöåÌï† ÎïåÎäî ÏûòÎêòÏóàÎäîÎç∞, Ï†ÑÏ≤¥ Ï°∞ÌöåÎ°ú Î∞îÍæ∏Îäî Î∂ÄÎ∂ÑÏóêÏÑú ÏàòÏ†ïÏùÑ ÏûòÎ™ªÌïòÏó¨ Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌïòÏòÄÏäµÎãàÎã§.

**Î¨∏Ï†úÍ∞Ä Îêú Î∂ÄÎ∂Ñ**

```sql
-- ÏòàÏãú Î¨∏Ï†ú ÏøºÎ¶¨ ÏòÅÏó≠
WITH target_item AS (SELECT *
                     FROM item_i18n
                     offset %s limit %s),

     -- üß© craftUnlock.rewardItems[*].item.idÏóê Ìè¨Ìï®Îêú Í≤ΩÏö∞ (finish_rewards Ïïà)
     filtered_quests_craft_unlock AS (SELECT qa.id    AS quest_id,
                                             qa.name,
                                             qa.npc_id,
                                             qa.url_mapping,
                                             tn.name  as npc_name,
                                             tn.image AS npc_image,
                                             reward_item
                                      FROM quest_i18n qa
                                               LEFT JOIN npc_i18n tn ON qa.npc_id = tn.id
                                               LEFT JOIN LATERAL jsonb_array_elements(qa.finish_rewards -> 'craftUnlock') AS craft_unlock
                                                         ON TRUE
                                               LEFT JOIN LATERAL jsonb_array_elements(craft_unlock -> 'rewardItems') AS reward_item
                                                         ON TRUE
                                      WHERE reward_item -> 'item' ->> 'id' IN (SELECT id FROM target_item)),

     -- ‚ùó items Î∞∞Ïó¥Ïóê Ìè¨Ìï®Îêú Í≤ΩÏö∞ (Ïòà: giveItem, plantItem, findItem)
     required_quests_by_items_array AS (SELECT q.id     AS quest_id,
                                               q.name,
                                               q.url_mapping,
                                               tn.name  as npc_name,
                                               tn.image AS npc_image,
                                               obj      AS objective
                                        FROM quest_i18n q
                                                 LEFT JOIN LATERAL jsonb_array_elements(q.objectives) AS obj ON TRUE
                                                 LEFT JOIN npc_i18n tn on q.npc_id = tn.id
                                        WHERE obj ->> 'type' IN ('plantItem', 'giveItem', 'findItem')
                                          AND EXISTS (SELECT 1
                                                      FROM jsonb_array_elements(obj -> 'items') AS item
                                                      WHERE item ->> 'id' in (SELECT id FROM target_item))),

     item_with_details AS (SELECT ti.id,

                                  -- ÌÄòÏä§Ìä∏ craftUnlockÏùò rewardItemsÏóê Ìè¨Ìï®Îêú Ï†ïÎ≥¥
                                  COALESCE(
                                                  json_agg(
                                                  DISTINCT jsonb_build_object(
                                                          'quest_id', fqc.quest_id,
                                                          'name', fqc.name,
                                                          'npc_name', fqc.npc_name,
                                                          'npc_image', fqc.npc_image,
                                                          'url_mapping', fqc.url_mapping,
                                                          'reward', fqc.reward_item
                                                           )
                                                          ) FILTER (WHERE fqc.quest_id IS NOT NULL),
                                                  '[]'
                                  ) AS rewarded_by_quests_craft_unlock,

                                  -- üìå items Î∞∞Ïó¥Ïóê Îì§Ïñ¥ ÏûàÎäî ÌÄòÏä§Ìä∏
                                  COALESCE(
                                                  json_agg(
                                                  DISTINCT jsonb_build_object(
                                                          'quest_id', rqa.quest_id,
                                                          'name', rqa.name,
                                                          'npc_name', rqa.npc_name,
                                                          'npc_image', rqa.npc_image,
                                                          'url_mapping', rqa.url_mapping,
                                                          'objective', rqa.objective
                                                           )
                                                          ) FILTER (WHERE rqa.quest_id IS NOT NULL),
                                                  '[]'
                                  ) AS required_by_quest_item_array

                           FROM target_item ti
                                    LEFT JOIN filtered_quests_craft_unlock fqc ON TRUE
                                    LEFT JOIN required_quests_by_items_array rqa ON TRUE
                           GROUP BY ti.id, ti.name, ti.name, ti.category, ti.image,
                                    ti.image_width, ti.image_height, ti.info, ti.update_time, ti.url_mapping)

SELECT id,
       rewarded_by_quests_craft_unlock,
       required_by_quest_item_array
FROM item_with_details
```

## ‚úÖ ÏµúÏ¢Ö Í∞úÏÑ† Í≤∞Í≥º ÏöîÏïΩ

- Airflow DAGÏóêÏÑú ÏïÑÏù¥ÌÖú ÏÉÅÏÑ∏Ï†ïÎ≥¥Î•º upsert Ï≤òÎ¶¨ÌïòÎäî Íµ¨Ï°∞Î°ú Î≥ÄÍ≤Ω
- Ï≤òÏùåÏóêÎäî `LIMIT + OFFSET` Í∏∞Î∞ò Î≥ëÎ†¨ Ï≤òÎ¶¨ DAGÏúºÎ°ú Íµ¨ÏÑ±ÌñàÏúºÎÇò, Ïò§ÌûàÎ†§ Î≥ëÎ™© Î∞úÏÉù
- ÏøºÎ¶¨ Ïò§Î•ò ÏàòÏ†ï ÌõÑ, Îã®Ïùº ÏøºÎ¶¨Î°ú Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Î•º ÏùºÍ¥Ñ Ï≤òÎ¶¨ ‚Üí ÏÑ±Îä• Í∏âÌñ•ÏÉÅ
  - 4200Ïó¨ Í±¥ Ï≤òÎ¶¨Ïóê 1ÏãúÍ∞ÑÏóêÏÑú 30Ï¥à Ïù¥ÎÇ¥Î°ú Î≥ÄÍ≤Ω

## üß† ÌöåÍ≥†: ÏïÑÏù¥ÌÖú ÏÉÅÏÑ∏Ï†ïÎ≥¥ ÏÑ±Îä• Í∞úÏÑ†Í∏∞

### üìå Î∞∞Í≤Ω

- Î≥µÏû°Ìïú JSON Îç∞Ïù¥ÌÑ∞Î•º ÌååÏã±ÌïòÏó¨ ÏïÑÏù¥ÌÖúÎ≥Ñ ÏÇ¨Ïö©Ï≤ò/Î≥¥ÏÉÅ Ï†ïÎ≥¥Î•º Ï¢ÖÌï© Ï†úÍ≥µÌïòÎäî ÏøºÎ¶¨Í∞Ä ÌïÑÏöî
- Ï¥àÍ∏∞ÏóêÎäî Ïó¨Îü¨ CTEÏôÄ JSON ÌååÏã±ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Îç∞Ïù¥ÌÑ∞Î•º Íµ¨ÏÑ±

---

### üõ† Î¨∏Ï†úÏ†ê

- `jsonb_array_elements` Î∞è LATERAL JOINÏùò Í≥ºÎèÑÌïú ÏÇ¨Ïö© ‚Üí ÏÑ±Îä• Ï†ÄÌïò
- `LEFT JOIN ON TRUE` Îì± Î¨¥Ï°∞Í±¥Ï†ÅÏù∏ Ï°∞Ïù∏ÏúºÎ°ú Ïù∏Ìï¥ Î∂àÌïÑÏöîÌïú Í≥ÑÏÇ∞Îüâ Î∞úÏÉù
- EXPLAIN Í≤∞Í≥º, Nested Loop Join Í≥ºÎã§ Î∞úÏÉù Î∞è ÎπÑÌö®Ïú®Ï†ÅÏù∏ Ïã§Ìñâ Í≥ÑÌöç
- Ï≤òÏùåÏóêÎäî Î¨∏Ï†úÏùò ÏõêÏù∏ÏùÑ Î™®Î•∏ Ï±Ñ DAGÏùÑ Î≥ëÎ†¨Î°ú Íµ¨ÏÑ± + LIMIT/OFFSET Ï†ÑÎûµ
  - Ïã§ÌñâÏùÄ Ïûò ÎêòÏßÄÎßå ÎÑàÎ¨¥ Ïò§Îûú ÏãúÍ∞ÑÏù¥ Í±∏Î†∏ÏäµÎãàÎã§ (1ÏãúÍ∞Ñ).

---

### üîç ÏõêÏù∏ Î∂ÑÏÑù

- ÏøºÎ¶¨ ÎÇ¥ ÌäπÏ†ï ÌïÑÎìú Ï°∞Í±¥ ÎàÑÎùΩÏúºÎ°ú Ïù∏Ìï¥ **Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Î•º Í≥ºÌïòÍ≤å JOIN**ÌïòÍ≥† ÏûàÏóàÏäµÎãàÎã§.
- ÏÑ±Îä• Î≥ëÎ™©Ïùò Ï£º ÏõêÏù∏Ïù¥ **Î∂àÌïÑÏöîÌïú Ï°∞Ïù∏**Í≥º **ÌïÑÌÑ∞ Ï°∞Í±¥ Î∂ÄÏû¨**ÏòÄÏäµÎãàÎã§.
- DAG Î≥ëÎ†¨ Ï≤òÎ¶¨Î≥¥Îã§ Î®ºÏ†Ä ÏøºÎ¶¨ Î°úÏßÅ ÏûêÏ≤¥ ÏµúÏ†ÅÌôîÍ∞Ä ÏÑ†ÌñâÎêòÏñ¥Ïïº ÌñàÏäµÎãàÎã§.

---

### ‚úÖ Í∞úÏÑ† Î∞è Í≤∞Í≥º

- Î¨∏Ï†ú Íµ¨Í∞ÑÏùò ÏøºÎ¶¨Î•º ÏàòÏ†ï ‚Üí Ï°∞Í±¥ Ï∂îÍ∞Ä Î∞è Î∂àÌïÑÏöîÌïú JOIN Ï†úÍ±∞
- ÏøºÎ¶¨ Task Î≥ëÎ†¨ Ï≤òÎ¶¨ ÏàòÌñâ
- Ïã§Ìñâ ÏãúÍ∞Ñ: **Í∏∞Ï°¥ 1ÏãúÍ∞Ñ ‚Üí ÏµúÏ†ÅÌôî ÌõÑ 30Ï¥à Ïù¥ÎÇ¥**
- AirflowÎ•º ÌÜµÌïú ÏùºÏùº upsert Íµ¨Ï°∞Î°ú ÏïàÏ†ïÏÑ± ÌôïÎ≥¥

**ÌòÑÏû¨ ÏïÑÏù¥ÌÖú ÏÉÅÏÑ∏ Ï°∞Ìöå ÏÜçÎèÑ**



https://github.com/user-attachments/assets/30ed75af-9ed6-4b8e-bb64-6332a7341c19


---

### ü§î Î∞∞Ïö¥ Ï†ê

- ÏÑ±Îä• Ïù¥ÏäàÎäî ÎåÄÎ∂ÄÎ∂Ñ **ÏøºÎ¶¨ ÏÑ§Í≥ÑÏùò Î¨∏Ï†ú**ÏóêÏÑú ÏãúÏûëÎêòÏóàÎã§Îäî Ï†ê
- **Î≥ëÎ†¨ Ï≤òÎ¶¨ÎÇò DAG Íµ¨ÏÑ±ÏùÄ Í∑ºÎ≥∏ ÏõêÏù∏ Ìï¥Í≤∞ ÌõÑÏóê Í≥†Î†§Ìï¥Ïïº Ìï† Î≥¥Ï°∞ ÏàòÎã®**Ïù¥ÎùºÎäî Ï†ê
- `EXPLAIN (ANALYZE)`Îäî ÌïÑÏàò ÎèÑÍµ¨, Î¨∏Ï†úÍ∞Ä ÏÉùÍ∏∞Î©¥ Í∞ÄÏû• Î®ºÏ†Ä Î¥êÏïº ÌïòÍ≥† costÏôÄ rowÍ∞Ä ÎπÑÏ†ïÏÉÅÏ†ÅÏù¥ÎùºÎ©¥ ÏøºÎ¶¨Î•º ÌôïÏù∏Ìï¥Î¥êÏïº ÌïúÎã§Îäî Ï†ê
- AirflowÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú Mapped TaskÎ•º ÎßåÎì§ Ïàò ÏûàÎã§Îäî Í≤É - ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ Ï¥ù Í∞úÏàòÏôÄ limit, offset Í∏∞Ï§ÄÏúºÎ°ú ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±
- Í≤∞Íµ≠ ÏÑ±Îä•ÏùÄ ÏΩîÎìúÎ≥¥Îã§ **Îç∞Ïù¥ÌÑ∞ Î™®Îç∏ÎßÅÍ≥º ÏøºÎ¶¨ Î°úÏßÅ ÏÑ§Í≥Ñ**Í∞Ä ÌïµÏã¨Ïù¥ÎùºÎäî ÍµêÌõàÏùÑ ÏñªÏóàÏäµÎãàÎã§.

---

### üìù Îã§ÏùåÏóêÎäî Ï†úÎ∞ú~~

- JSON ÌïÑÎìúÎäî Í∞ÄÎä•ÌïòÎ©¥ ÏÇ¨Ï†Ñ Ï†ïÍ∑úÌôîÌïòÍ±∞ÎÇò, ETL Îã®Í≥ÑÏóêÏÑú ÌååÏã± Ï≤òÎ¶¨ÌïòÍ∏∞
- Î≥µÏû°Ìïú ÏøºÎ¶¨Îäî Ï≤òÏùåÎ∂ÄÌÑ∞ ÏÑ±Îä• Ï∏°Ï†ï ÌõÑ ÏÑ§Í≥ÑÌïòÍ∏∞
- DAG ÏÑ§Í≥ÑÎäî "ÏÑ±Îä• Î≥ëÎ™© Ï†úÍ±∞ ÌõÑ" ÎèÑÏûÖÌïòÍ∏∞
- ÏøºÎ¶¨Îäî Íº≠ Ïó¨Îü¨Î≤à ÌôïÏù∏ÌïòÍ∏∞

### Dag Mapped Task Code

ÌòÑÏû¨ Ï†ÅÏö©Ï§ëÏù∏ ÏïÑÏù¥ÌÖú ÏÉÅÏÑ∏ Dynamic Task ÏΩîÎìú ÏûÖÎãàÎã§.

```python
from airflow.decorators import dag, task
from airflow.providers.postgres.hooks.postgres import PostgresHook
from contextlib import closing
import pendulum
from custom_module.psql_func import read_sql

BATCH_SIZE = 500


@dag(
    dag_id="dags_item_detail_upsert",
    start_date=pendulum.datetime(2024, 5, 1, tz="Asia/Seoul"),
    schedule_interval="50 0 * * *",
    catchup=False,
    max_active_tasks=10,
    default_args={
        "owner": "airflow",
        "retries": 1,
        "retry_delay": pendulum.duration(minutes=5),
    },
    tags=["postgresql", "tarkov-dev-api"],
)
def item_detail_upsert():

    @task
    def get_total_count(postgres_conn_id: str) -> int:
        hook = PostgresHook(postgres_conn_id)
        sql = read_sql("item_count.sql")
        with closing(hook.get_conn()) as conn, closing(conn.cursor()) as cur:
            cur.execute(sql)
            return cur.fetchone()[0]

    @task
    def make_ranges(total_count: int) -> list[dict]:
        """
        XCom(Î¶¨Ïä§Ìä∏) ‚Üí process_batch Ïóê Îß§ÌïëÎê®.
        Í∞Å dictÍ∞Ä ÌïòÎÇòÏùò Task Ïù∏Ïä§ÌÑ¥Ïä§(Worker Slot)Î•º ÏÉùÏÑ±.
        """
        return [
            {"start": start, "end": min(start + BATCH_SIZE, total_count)}
            for start in range(0, total_count, BATCH_SIZE)
        ]

    @task
    def process_batch(batch: dict, postgres_conn_id: str):
        start, end = batch["start"], batch["end"]
        hook = PostgresHook(postgres_conn_id)
        sql = read_sql("item_detail_upsert.sql")
        with closing(hook.get_conn()) as conn, closing(conn.cursor()) as cur:
            cur.execute(sql, (start, end))
            conn.commit()

    total = get_total_count(postgres_conn_id="tkl_db")
    ranges = make_ranges(total)
    process_batch.expand(batch=ranges, postgres_conn_id=["tkl_db"])


dag = item_detail_upsert()
```
